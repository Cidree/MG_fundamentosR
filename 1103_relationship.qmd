---
execute: 
  warning: false
editor_options: 
  chunk_output_type: console
filters: 
    - webr
webr:
    packages: ["dplyr", "ggplot2"]
---

# Gr√°ficos de relaci√≥n

Los gr√°ficos de relaci√≥n son aquellos que nos permiten visualizar la relaci√≥n que tienen entre s√≠ dos o m√°s variables. Dentro de los gr√°ficos de relaci√≥n tambi√©n se puede denominar gr√°ficos de correlaci√≥n, y agrupan una familia m√°s grande que la que ve√≠amos en la @fig-vis-classification.

En este cap√≠tulo veremos los siguientes gr√°ficos de relaci√≥n:

1.  Gr√°fico de dispersi√≥n (*Scatter plot*)

2.  Gr√°fico de burbujas (*Bubble plot*)

3.  Mapas de calor (*Heatmap*)

En este cap√≠tulo vamos a trabajar con tres *datasets*:

-   `iris`: *dataset* donde se han medido la longitud y anchura de p√©talos y s√©palos de 150 flores, adem√°s de la especie a la que pertenecen (ver [Tipos de visualizaci√≥n](#sec-visualization-types){target="_blank"}).

-   `gapminder`: *dataset* con la evoluci√≥n temporal del desarrollo econ√≥mico, poblaci√≥n y esperanza de vida de los pa√≠ses del mundo (ver [Tipos de visualizaci√≥n](#sec-visualization-types){target="_blank"}). Filtraremos solamente los datos del 2002.

-   `inventario`: *dataset* con datos de inventario de 27 parcelas en los que se ha medido el DBH, altura y especie (ver @sec-vis-data).

Para comenzar, vamos a cargar los paquetes necesarios y a leer los datos que utilizaremos en este cap√≠tulo.

```{r}
#| include: false
## Paquetes internos
library(ggtext)
library(gt)
```

```{r}
# Cargar paquetes
library(gapminder)
library(GGally)
library(tidyverse)
# Cargar datos
inventario_tbl <- read_rds("data/inventario_prep.rds")
gapminder_tbl <- gapminder |> 
    filter(year == 2002)
```

## Objetivos

Al final de este cap√≠tulo ser√°s capaz de:

-   Utilizar un tema distinto por defecto

-   Crear gr√°ficos de dispersi√≥n y burbujas

-   Crear mapas de calor

-   Crear gr√°ficos de correlaci√≥n

-   A√±adir texto como geometr√≠a a los gr√°ficos

-   Controlar colores utilizando `scales`

-   Mover la leyenda

## Gr√°ficos de dispersi√≥n

Antes de empezar, vamos a ver como modificar el tema que viene por defecto en `{ggplot2}`, para que no tengamos que a√±adirlo en cada gr√°fico que hagamos.

Utilizando la funci√≥n `theme_set()` podemos establecer un tema por defecto para todos los gr√°ficos que hagamos en el documento. En este caso, hemos seleccionado el tema `theme_classic()`, que es uno de los temas m√°s utilizados en `{ggplot2}`.

```{r}
theme_set(
    theme_classic()
)
```

Los gr√°ficos de dispersi√≥n son una de las formas m√°s comunes de visualizar la relaci√≥n entre dos **variables num√©ricas**. En un gr√°fico de dispersi√≥n, cada punto representa una observaci√≥n y se coloca en el eje `x` seg√∫n el valor de la primera variable y en el eje `y` seg√∫n el valor de la segunda variable.

Para crear un gr√°fico de dispersi√≥n en `ggplot2` se utiliza la funci√≥n `geom_point()`. A continuaci√≥n, se muestra un ejemplo de c√≥mo crear un gr√°fico de dispersi√≥n utilizando el *dataset* `gapminder` relacionando el PIB per c√°pita con la esperanza de vida, y coloreando los puntos seg√∫n el continente.

```{r}
#| label: fig-dispersion-scatter
#| fig-cap: Gr√°fico de dispersi√≥n con ggplot2
## Crear gr√°fico
base_scatter_gg <- gapminder_tbl |> 
    ggplot(
        aes(x = gdpPercap, y = lifeExp, color = continent)
    ) +
    geom_point(
        size = 2
    ) +
    labs(
        x = "PIB per c√°pita",
        y = "Esperanza de vida"
    )
## Imprimir
base_scatter_gg
```

F√≠jate que como hemos utilizado `theme_set()` al principio del documento, no hemos tenido que a√±adir `theme_classic()` en el gr√°fico.

Pues as√≠ de sencillo es crear un gr√°fico de dispersi√≥n en `ggplot2`. Como ya estamos familiarizados con la funcionalidad b√°sica, vamos a aprender a cambiar los colores de los puntos y a mover la leyenda.

Vamos a empezar modificando los colores de cada uno de los continentes para que sean:

-   `√Åfrica`: naranja

-   `Am√©rica`: negro

-   `Asia`: lila

-   `Europa`: azul

-   `Ocean√≠a`: verde

Si record√°is, en la @sec-components-scales ve√≠amos que las variables num√©ricas traen por defecto una escala continua (i.e. `scale_*_continuous()`) y las variables categ√≥ricas una escala de discreta (i.e. `scale_*_discrete()`).

En este caso, queremos cambiar los colores de las especies, y para ello tenemos que modificar la escala a `manual` con la funci√≥n `scale_color_manual()`. A continuaci√≥n, se muestra el c√≥digo para cambiar los colores de las especies:

```{r}
#| label: fig-dispersion-scatter-colors
#| fig-cap: Gr√°fico de dispersi√≥n con ggplot2
## Crear gr√°fico
scales_scatter_gg <- base_scatter_gg +
    scale_color_manual(
        name   = "Continente",
        values = c("#FF5733", "black", "#A833FF", "#3366FF", "#33FF57")
    )
## Imprimir
scales_scatter_gg
```

Con el argumento `name` de las funciones `scale*` podemos cambiar el nombre de la leyenda, y en `values` tenemos que especificar un vector con los colores que queremos asignar a cada categor√≠a.

::: callout-note
En @fig-dispersion-scatter-colors hemos asignado a `values` un vector de longitud 5 porque tenemos 5 categor√≠as (1 por continente). Si asignamos m√°s colores de los necesarios, la funci√≥n los ignorar√°, mientras que si asignamos menos, la funci√≥n nos dar√° el error: *`Insufficient values in manual scale`*
:::

Lo siguiente que vamos a aprender es a mover la leyenda. Aqu√≠ tenemos dos opciones:

-   Utilizar una posici√≥n relativa al gr√°fico

-   Utilizar una posici√≥n absoluta dentro del gr√°fico

Vamos a utilizar el m√©todo introducido en la versi√≥n 3.5.0 de `{ggplot2}` que es el siguiente:

::: panel-tabset
## Posici√≥n relativa

La posici√≥n relativa es la m√°s sencilla. La forma **recomendable** es la siguiente, ya que si tuvi√©ramos m√°s de una leyenda, podr√≠amos controlar la posici√≥n de cada una dentro de `guides`.

Lo que estamos haciendo es: (1) utilizar la funci√≥n `guides`; (2) como argumento utilizar el nombre la est√©tica de la leyenda que queremos modificar (`color`); (3) utilizar la funci√≥n `guide_legend()` que tiene muchos argumentos para modificar la leyenda.

```{shinylive-r}
#| standalone: true
#| viewerHeight: 600

## Load packages
library(bslib)
library(dplyr)
library(gapminder)
library(ggplot2)
library(glue)
library(shiny)

## UI
ui <- page_sidebar(
    sidebar = sidebar(
        open = "open",
        width = 200,
        selectInput(
            inputId = "position_input", 
            label   = "Posici√≥n", 
            choices = c("bottom", "top", "left", "right", "inside"),
        )
    ),
    verbatimTextOutput("code") |> card(),
    plotOutput("plot", width = 500) |> card()
)

## Server
server <- function(input, output, session) {
    
    output$code <- renderPrint({
        glue(
            '
            scales_scatter_gg +
                guides(
                    color = guide_legend(
                        position = "{input$position_input}"
                    )
                )'
            )
    })

    ## Plot
    output$plot <- renderPlot({
        gapminder |> 
            filter(year == 2002) |> 
            ggplot(
                aes(x = gdpPercap, y = lifeExp, color = continent)
            ) +
            geom_point(
                size = 2
            ) +
            labs(
                x = "PIB per c√°pita",
                y = "Esperanza de vida"
            ) +
            scale_color_manual(
                name   = "Continente",
                values = c("#FF5733", "black", "#A833FF", "#3366FF", "#33FF57")
            ) +
            guides(
                color = guide_legend(
                    position = {input$position_input}
                )
            ) +
            theme_bw(base_size = 8)
        }, res = 96
    )
}

## Run app
shinyApp(ui = ui, server = server)
```

## Posici√≥n absoluta

Para la posici√≥n absoluta, debemos utilizar `position = "inside"`. Una vez hecho esto, debemos modificar el argumento `legend.position.inside` dentro de la funci√≥n `theme()` indicar un vector num√©rico de longitud 2, donde el primer n√∫mero indica el % de desplazamiento sobre el eje `x` desde el origen, mientras que el segundo n√∫mero indica el % de desplazamiento sobre el eje `y`. Prueba a cambiar los valores en la siguiente aplicaci√≥n para entender su funcionamiento:

```{shinylive-r}
#| standalone: true
#| viewerHeight: 600

## Load packages
library(bslib)
library(dplyr)
library(gapminder)
library(ggplot2)
library(glue)
library(shiny)

## UI
ui <- page_sidebar(
    sidebar = sidebar(
        open = "open",
        width = 200,
        sliderInput(
            inputId = "position_input_x", 
            label   = "Posici√≥n eje x",
            min     = 0,
            max     = 1,
            value   = 0.5,
            step    = 0.1
        ),
        sliderInput(
            inputId = "position_input_y", 
            label   = "Posici√≥n eje y",
            min     = 0,
            max     = 1,
            value   = 0.5,
            step    = 0.1
        )
    ),
    verbatimTextOutput("code") |> card(),
    plotOutput("plot", width = 500) |> card()
)

## Server
server <- function(input, output, session) {
    
    output$code <- renderPrint({
        glue(
            '
            scales_scatter_gg +
                guides(
                    color = guide_legend(
                        position = "inside"
                    )
                ) +
                theme(
                    legend.position.inside = c({input$position_input_x}, {input$position_input_y})'
            )
    })

    ## Plot
    output$plot <- renderPlot({
        gapminder |> 
            filter(year == 2002) |> 
            ggplot(
                aes(x = gdpPercap, y = lifeExp, color = continent)
            ) +
            geom_point(
                size = 2
            ) +
            labs(
                x = "PIB per c√°pita",
                y = "Esperanza de vida"
            ) +
            scale_color_manual(
                name   = "Continente",
                values = c("#FF5733", "black", "#A833FF", "#3366FF", "#33FF57")
            ) +
            guides(
                color = guide_legend(
                    position = "inside"
                )
            ) +
            theme_bw(base_size = 8) +
            theme(
                legend.position.inside = c(input$position_input_x, input$position_input_y))
            }, res = 96
    )
}

## Run app
shinyApp(ui = ui, server = server)
```
:::

## Gr√°ficos de burbujas

Los gr√°ficos de burbujas son una extensi√≥n de los gr√°ficos de dispersi√≥n, donde se a√±ade una **tercera variable num√©rica** que se representa mediante el tama√±o de los puntos.

::: callout-note
En la pr√°ctica, si utilizamos las est√©ticas de `color` y `size`, estamos visualizando 4 variables num√©ricas al mismo tiempo!!
:::

En `ggplot2`, podemos a√±adir una tercera variable utilizando la est√©tica `size` en la funci√≥n `aes()`. Al *scatter plot* anterior, vamos a a√±adirle como variable de `size` la poblaci√≥n. Como vamos a a√±adir nuevos elementos, vamos a a√±adir el c√≥digo paso a paso:

::: panel-tabset
## 1. Bubble plot

Empezamos generando un *bubble plot* a√±adiendo la variable *pop:*

```{r}
## Crear gr√°fico
bubble_base <- gapminder_tbl |> 
    ggplot(
        aes(x = gdpPercap, y = lifeExp, color = continent, size = pop)
    ) +
    geom_point(
        alpha = 0.7
    ) +
    labs(
        x = "PIB per c√°pita",
        y = "Esperanza de vida"
    ) +
    scale_color_manual(
        name   = "Continente",
        values = c("#FF5733", "black", "#A833FF", "#3366FF", "#33FF57")
    )
## Imprimir
bubble_base
```

## 2. Tama√±o puntos

El tama√±o de los puntos al igual que el color de los mismos es una est√©tica. Para modificar una est√©tica mapeada a una variable utilizamos las funciones `scale_*`. Como la est√©tica es `size`, utilizamos `scale_size*()`. En el argumento `range` indicamos el tama√±o del punto m√°s peque√±o y el tama√±o del punto m√°s grande:

```{r}
## Crear gr√°fico
bubble_size <- bubble_base +
    scale_size(range = c(1, 15))
## Imprimir
bubble_size
```

## 3. Eliminar una leyenda

Recuerdas la funci√≥n `guides` que vimos antes? Si igualamos una de las est√©ticas a `"none"` eliminaremos solamente esa leyenda:

```{r}
## Crear gr√°fico
bubble_guides <- bubble_size +
    guides(
        size = "none"
    )
## Imprimir
bubble_guides
```

## 4. Posicionar leyenda

Para terminar, vamos a posicionar la leyenda del continente en la parte inferior derecha del gr√°fico para aprovechar el espacio:

```{r}
## Crear gr√°fico
bubble_final <- bubble_guides +
    guides(
        color = guide_legend(
            position = "inside"
        )
    ) +
    theme(
        legend.position.inside = c(.9, .2)
    ) 
## Imprimir
bubble_final
```

## 5. Resumen

Este gr√°fico nos muestra que los pa√≠ses con menor PIB per c√°pita son tambi√©n aquellos con generalmente menor esperanza de vida y se encuentran principalmente en √Åfrica.

Para terminar, vamos a ver como se ver√≠a todo el c√≥digo en un solo bloque:

```{r}
gapminder_tbl |> 
    ## Capas
    ggplot(
        aes(x = gdpPercap, y = lifeExp, color = continent, size = pop)
    ) +
    geom_point(
        alpha = 0.7
    ) +
    ## Etiquetas
    labs(
        x = "PIB per c√°pita",
        y = "Esperanza de vida"
    ) +
    ## Escalas y gu√≠as
    scale_color_manual(
        name   = "Continente",
        values = c("#FF5733", "black", "#A833FF", "#3366FF", "#33FF57")
    ) +
    scale_size(range = c(1, 15)) +
    guides(
        size  = "none",
        color = guide_legend(
            position = "inside"
        )
    ) +
    ## Temas
    theme(
        legend.position.inside = c(.9, .2)
    ) 
```
:::

Uff üò•... Si es tu primera vez estudiando `{ggplot2}` es posible que te est√© explotando la cabeza. No te preocupes!! Es normal que al principio te cueste, pero poco a poco iremos domin√°ndolo juntosüòé.

### Ejercicio 7

Es hora de ponerse manos a la obra! El objetivo del siguiente ejercicio es replicar el siguiente gr√°fico con el *dataset* de `iris`. Recuerda la estructura de los datos:

```{r}
#| echo: false
#| label: tbl-iris-head
#| tbl-cap: Estructura de los datos de Iris
head(iris) |> 
    gt() |> 
    opt_stylize(style = 5)
```

::: panel-tabset
## Gr√°fico esperado

Intenta replicar este gr√°fico en la pesta√±a "Ejercicio"

```{r}
#| echo: false
#| label: fig-distribution-ej7
#| fig-cap: Resultado esperado del ejercicio 7
iris |> 
    ggplot(
        aes(
            x = Petal.Length, 
            y = Petal.Width,
            color = Species,
            size  = Sepal.Length
        )
    ) +
    geom_point() +
    labs(
        title = "Relaci√≥n entre longitud de p√©talo, anchura de p√©talo y longitud de s√©palo",
        x = "Longitud de p√©talo (mm)",
        y = "Anchura de p√©talo (mm)"
    ) +
    scale_color_manual(
        name   = "Especies",
        values = c("#FF6347", "#4682B4", "#32CD32")
    ) +
    scale_size(range = c(1, 5)) +
    guides(
        size = "none",
        color = guide_legend(position = "inside")
    ) +
    theme(
        legend.position.inside = c(.1, .8)
    )

```

## Ejercicio

Completar el c√≥digo:

```{webr-r}
iris |> 
    ## Introducir c√≥digo
    labs(
        title = "Relaci√≥n entre longitud de p√©talo, anchura de p√©talo y longitud de s√©palo",
        x = "Longitud de p√©talo (mm)",
        y = "Anchura de p√©talo (mm)"
    ) 
```

## Soluci√≥n

```{r}
#| label: fig-distribution-ej7-sol
#| fig-cap: Soluci√≥n del ejercicio 7
iris |> 
    ggplot(
        aes(
            x = Petal.Length, 
            y = Petal.Width,
            color = Species,
            size  = Sepal.Length
        )
    ) +
    geom_point() +
    labs(
        title = "Relaci√≥n entre longitud de p√©talo, anchura de p√©talo y longitud de s√©palo",
        x = "Longitud de p√©talo (mm)",
        y = "Anchura de p√©talo (mm)"
    ) +
    scale_color_manual(
        name   = "Especies",
        values = c("#FF6347", "#4682B4", "#32CD32")
    ) +
    scale_size(range = c(1, 5)) +
    guides(
        size = "none",
        color = guide_legend(position = "inside")
    ) +
    theme(
        legend.position.inside = c(.1, .8)
    )
```
:::

## Mapas de calor

Dentro de los mapas de calor voy a hacer una clasificaci√≥n para entender sus dos principales usos:

1.  **Mapa de calor cl√°sico**: El primero ser√° un mapa de calor donde comparamos el valor de una variable num√©rica (o una categ√≥rica) **en funci√≥n de dos variables categ√≥ricas**.

2.  **Mapa de calor de correlaci√≥n**: El segundo ser√° un mapa de calor donde comparamos la **correlaci√≥n** entre las variables num√©ricas de un *dataset*.

::: calllout-note
Esta nomenclatura es propia y no tiene por qu√© ser la misma que se utiliza en la literatura.
:::

### Mapa de calor cl√°sico

Los mapas de calor son una forma de visualizar la relaci√≥n entre las categor√≠as de dos variables categ√≥ricas y una variable num√©rica (o otra categ√≥rica). Las categor√≠as de las variables categ√≥ricas se representan en los ejes `x` e `y`, y la variable num√©rica se representa mediante el color de las celdas.

::: callout-note
Existen tres funciones en `ggplot2` que nos permiten crear mapas de calor: `geom_tile()`, `geom_raster()` y `geom_rect()`.
:::

Vamos a ver la evoluci√≥n de la esperanza de vida en los pa√≠ses de Europa a lo largo de los a√±os. Para ello, vamos a utilizar el *dataset* `gapminder` y filtrar los datos de Europa:

::: panel-tabset
## Primer heatmap

Para crear el primer *heatmap* vamos a utilizar la funci√≥n `geom_tile()`. En el eje `x` utilizamos los a√±os, en el eje `y` los pa√≠ses europeos, y como esta geometr√≠a dibuja pol√≠gonos, los coloreamos con la est√©tica `fill`:

```{r}
#| label: fig-heatmap
#| fig-cap: Primer mapa de calor con `{ggplot2}`
gapminder |> 
    filter(continent == "Europe") |> 
    ## Crear gr√°fico
    ggplot(
        aes(x = year, y = country, fill = lifeExp)
    ) +
    geom_tile() +
    labs(
      x = NULL,
      y = NULL,
      fill = "Esperanza de vida"
    )
```

Como primer intento est√° bien... Pero puedes ver lo que ocurre en el eje `x`? Los a√±os son n√∫meros s√≠, pero son una variable categ√≥rica en esto datos. Tenemos un n√∫mero peque√±o de a√±os que queremos tratar como categor√≠as, no como n√∫meros.

::: callout-tip
Puedes ver que para eliminar los t√≠tulos de los ejes utilizamos `y = NULL` y `x = NULL`.
:::

## Convertir a√±os

Recuerdas c√≥mo hac√≠amos para convertir una variable a categ√≥rica? Exacto, utilizamos la funci√≥n `as.factor()`, que adem√°s es muy conveniente ya que ordena los niveles de la variable alfab√©ticamente:

```{r}
#| label: fig-heatmap2
#| fig-cap: Segundo mapa de calor con `{ggplot2}`
gapminder |> 
    filter(continent == "Europe") |> 
    mutate(
        year = as.factor(year)
    ) |> 
    ## Crear gr√°fico
    ggplot(
        aes(x = year, y = country, fill = lifeExp)
    ) +
    geom_tile() +
    labs(
      x = NULL,
      y = NULL,
      fill = "Esperanza de vida"
    )
```

Solucionado! Ahora ya sabemos a qu√© a√±o pertenece cada celda. Vamos a intentar formatear un poco m√°s el gr√°fico... Vamos a utilizar una paleta de colores adecuada y ordenar los pa√≠ses para que Albania sea el primero en la parte superior.

## Personalizar

En la @fig-heatmap3 se muestra el resultado final. Vamos a ver lo que hemos hecho:

-   Hemos ordenado los pa√≠ses utilizando la funci√≥n `fct_rev()` del paquete `{forcats}`. Esta funci√≥n invierte el orden de los factores.

-   Hemos utilizado la paleta de colores [viridis](https://cran.r-project.org/web/packages/viridis/vignettes/intro-to-viridis.html) con la funci√≥n `scale_fill_viridis_c()`. Utilizamos `scale_fill_*`, porque la est√©tica que modificamos es `fill`. A continuaci√≥n, a√±adimos `scale_fill_viridis_*` que es una funci√≥n que tiene unas paletas de colores muy utilizadas y viene implementada en `{ggplot2}`, y finalmente a√±adimos la `c`, que quiere decir que la variable de la est√©tica `fill` es una variable **c**ontinua.

```{r}
#| label: fig-heatmap3
#| fig-cap: Mapa de calor personalizado
gapminder |> 
  filter(continent == "Europe") |> 
  mutate(
      year = as.factor(year)
  ) |> 
  ggplot(
      aes(x = year, y = fct_rev(country), fill = lifeExp)
  ) +
  geom_tile() +
  labs(
    x = NULL,
    y = NULL,
    fill = "Esperanza de vida"
  ) +
  scale_fill_viridis_c() +
  theme_minimal() 
```

## Etiquetas

Algo com√∫n en los mapas de calor es presentarlos como tablas de colores, donde no solamente tenemos las celdas de colores, si no tambi√©n el dato real que representan. Para a√±adirlos, vamos a a√±adir un nueva geometr√≠a que es `geom_text()`, que tiene 3 est√©ticas obligatorias: `x`, `y` y `label`. Las dos primeras ser√°n la posici√≥n de la etiqueta, y `label` ser√° el texto que se muestra:

```{r}
#| label: fig-heatmap4
#| fig-cap: Heatmap con etiquetas
gapminder |> 
    filter(continent == "Europe") |> 
    mutate(
        year    = as.factor(year),
        lifeExp = round(lifeExp, 1)
    ) |> 
    ggplot(
        aes(x = year, y = fct_rev(country))
    ) +
    geom_tile(
        aes(fill = lifeExp),
        show.legend = FALSE
    ) +
    geom_text(
        aes(label = lifeExp),
        size = 2.5
    ) +
    labs(
        x = NULL,
        y = NULL,
        title = "La esperanza de vida en los pa√≠ses europeos aument√≥ considerablemente"
    ) +
    scale_fill_gradientn(
        colours = hcl.colors(10, "Blues", rev = TRUE)
    ) +
    theme_minimal() +
    theme(
        plot.title = element_text(
            size  = 10,
            face  = "bold", 
            hjust = .5
        )
    )
```

Hemos a√±adido `scale_fill_grandientn()` que es el equivalente a `scale_fill_manual()` para variables continuas. La funci√≥n `hcl.colors()` simplemente nos devuelve un vector de colores:

```{r}
#| code-fold: false
hcl.colors(10, "Blues", rev = T)
```

F√≠jate que tambi√©n hemos movido `aes(fill = lifeExp)`. Se te ocurre por qu√© puede ser esto? Dentro de `ggplot()` introducimos las est√©ticas que queremos que hereden el resto de geometr√≠as, y `fill` solamente la queremos para `geom_tile()` mientras que `label` solamente la queremos para `geom_text()`.

Y finalmente, modificamos el t√≠tulo del gr√°fico para reducir su tama√±o base, ponerlo en negrita y justificarlo en el medio. No te preocupes si la sintaxis de la componente `theme()` te parece extra√±a, nos iremos familiarizando con ella poco a poco.
:::

Y con esto hemos visto el primer tipo de de *heatmaps*. Vamos a realizar un ejercicio utilizando los datos de inventario:

### Ejercicio 8

Utilizar de nuevo los datos de inventario para generar un *heatmap* donde se muestre el **DBH medio por parcela y especie**. Ten en cuenta que debes calcularlo. En la pesta√±a "Pista" tendr√°s la parte que genera estos datos, y que ser√°n los datos que utilizar√°s en `ggplot()`.

La estructura de los datos era la siguiente:

```{webr-r}
#| context: setup
#| autorun: true
## Url de los datos
url <- "https://cidree.github.io/MG_datasets/inventario_prep.csv"
inventario_tbl <- read.csv(url) |> as_tibble()
```

```{webr-r}
#| autorun: true
## Estructura datos
inventario_tbl
```

::: panel-tabset
## Gr√°fico esperado

El resultado esperado es el de la @fig-distribution-ej8.

::: callout-tip
Para conseguir las dimensiones del gr√°fico tenemos que a√±adir la componente `coord_fixed(ratio = .5)`. Esto hace que una unidad del eje `x` sea equivalente a 0.5 unidades del eje `y` y por lo tanto, los rect√°ngulos tengan el doble de longitud en `x`
:::

```{r}
#| echo: false
#| label: fig-distribution-ej8
#| fig-cap: Resultado esperado del ejercicio 8

inventario_tbl |> 
    summarise(
        dbh_mean = mean(dbh_mm, na.rm = TRUE) / 10,
        .by = c(id_plots, nombre_ifn)
    ) |> 
    mutate(
        dbh_mean = round(dbh_mean)
    ) |> 
    ggplot(
        aes(y = nombre_ifn, x = id_plots)
    ) +
    geom_tile(
        aes(fill = dbh_mean),
        show.legend = FALSE
    ) +
    geom_text(
        aes(label = dbh_mean),
        size = 2.5
    ) +
    scale_fill_gradientn(
        colours = hcl.colors(10, "Greens", rev = TRUE)
    ) +
    theme_minimal() +
    labs(
        x = "Parcela",
        y = NULL,
        title = "DBH medio (cm) por parcela y especie"
    ) +
    coord_fixed(ratio = .5) +
    theme(
        plot.title = element_text(hjust = .5, face = "bold")
    )

```

## Ejercicio

La paleta de colores utilizada es `hcl.colors(10, "Greens", rev = TRUE)`.

```{webr-r}
## Escribe el c√≥digo aqu√≠
inventario_tbl
```

## Pista

El procesado de los datos es el siguiente:

```{r}
inventario_tbl |> 
    summarise(
        dbh_mean = mean(dbh_mm, na.rm = TRUE) / 10,
        .by = c(id_plots, nombre_ifn)
    ) |> 
    mutate(
        dbh_mean = round(dbh_mean)
    )
```

## Soluci√≥n

La soluci√≥n al ejercicio es:

```{r}
#| label: fig-distribution-ej8-sol
#| fig-cap: Resultado final del ejercicio 8
inventario_tbl |> 
    summarise(
        dbh_mean = mean(dbh_mm, na.rm = TRUE) / 10,
        .by = c(id_plots, nombre_ifn)
    ) |> 
    mutate(
        dbh_mean = round(dbh_mean)
    ) |> 
    ggplot(
        aes(y = nombre_ifn, x = id_plots)
    ) +
    geom_tile(
        aes(fill = dbh_mean),
        show.legend = FALSE
    ) +
    geom_text(
        aes(label = dbh_mean),
        size = 3
    ) +
    scale_fill_gradientn(
        colours = hcl.colors(10, "Greens", rev = TRUE)
    ) +
    theme_minimal() +
    labs(
        x = "Parcela",
        y = NULL,
        title = "DBH medio (cm) por parcela y especie"
    ) +
    coord_fixed(ratio = .5) +
    theme(
        plot.title = element_text(hjust = .5, face = "bold")
    )
```
:::

Felicidades ü•≥ !!! Hemos aprendido mucho hasta este punto. Aunque est√©s confuso por el uso de algunas funciones del tipo `scale_*` o `coords_*`, no te preocupes! Esto ser√° cuesti√≥n de otro tema dedicado a ellas. De momento vamos introduciendo poco a poco estas componentes para que los ejercicios no sean solamente geometr√≠as, y para que te vayas familiarizando poco a poco con la gram√°tica. Sin m√°s dilaci√≥n, vamos a ver el siguiente tipo de *heatmaps*.

### Mapa de calor de correlaci√≥n

Los mapas de calor de correlaci√≥n (*correlacion heatmaps*) son una forma de visualizar la relaci√≥n entre **las variables num√©ricas** de un *dataset*. En estos mapas, las variables se representan en los ejes `x` e `y`, y la correlaci√≥n entre ellas se representa mediante el color de las celdas.

Para entender esto, debemos definir la correlaci√≥n. La correlaci√≥n es una medida estad√≠stica que describe la relaci√≥n entre dos variables y tiene la siguiente f√≥rmula:

$$
r_{xy} = \frac{cov(x,y)}{SD_x \cdot SD_y}
$$ {#eq-pearson1}

$$
r_{xy} = \frac{\sum_{i=1}^{n} (x_i - \bar{x})(y_i - \bar{y})}{\sqrt{\sum_{i=1}^{n} (x_i - \bar{x})^2 \sum_{i=1}^{n} (y_i - \bar{y})^2}}
$$ {#eq-pearson2}

T√©cnicamente, esto es la [correlaci√≥n de Pearson](https://es.wikipedia.org/wiki/Coeficiente_de_correlaci%C3%B3n_de_Pearson){target="_blank"} y mide el grado de correlaci√≥n **lineal** entre la variable `x` y la variable `y` dando como resultado un n√∫mero entre -1 y 1 donde:

-   Valores negativos: cuando los valores de una variable aumentan, los de la otra disminuyen

-   Valores cercanos a 0: no existe relaci√≥n lineal entre las variables

-   Valores positivos: cuando los valores de una variable aumentan, lo de la otra tambi√©n

En la siguiente figura se muestran varios ejemplos:

![Ejemplos de valores del coeficiente de correlaci√≥n de Pearson para distintas combinaciones de dos variables. Fuente: [Wikipedia](https://es.wikipedia.org/wiki/Coeficiente_de_correlaci%C3%B3n_de_Pearson#/media/Archivo:Correlation_examples2.svg){target="_blank"}](images/correlacion-pearson.png){#fig-correlation-types fig-align="center"}

En este sentido, vamos a generar el *correlation heatmap* para los datos de `iris`:

::: panel-tabset
## Correlaci√≥n

La correlaci√≥n se calcula solamente para variables num√©ricas, as√≠ que para seleccionar solamente estas, y calcular la correlaci√≥n con la funci√≥n `cor()`:

```{r}
## Calcular correlaci√≥n
iris_cor <- iris |> 
    select(
        where(is.numeric)
    ) |> 
    cor()
## Imprimir
iris_cor
```

La diagonal ser√° siempre 1, ya que la correlaci√≥n de una variable consigo misma siempre ser√° una recta.

## Correlation heatmap

Existen muchos paquetes que traen funciones internas que a partir de la matriz de correlaci√≥n crean un *correlation heatmap*. Uno de mis favoritos es `{GGally}`.

De hecho, gracias a este paquete, no tenemos que realizar el paso anterior, y simplemente a√±adiendo nuestro datos a la funci√≥n `ggcor()`, har√° el trabajo por nosotros:

```{r}
#| label: fig-correlation-heatmap
#| fig-cap: Mapa de calor de correlaci√≥n simple con `{GGally}`
ggcorr(iris)
```

Esta funci√≥n tiene par√°metros que podemos modificar. Adem√°s, como es un objeto de `{ggplot2}`, podemos modificarlo como tal:

```{r}
#| label: fig-correlation-heatmap2
#| fig-cap: Mapa de calor de correlaci√≥n personalizado con `{GGally}`
ggcorr(
    iris,
    label       = TRUE,
    label_round = 2
) +
    labs(
        title = "Correlaci√≥n de Pearson del dataset de {iris}"
    ) +
    theme(
        plot.title = element_text(
            hjust = .5,
            face  = "bold"
        )
    )
```

Compara los valores de las etiquetas con los que obtuvimos al utilizar la funci√≥n `cor()`.

## Correlaci√≥n por categor√≠as

Finalmente, tenemos la opci√≥n de a√±adir una variable categ√≥rica como puede ser la especie de Iris, y ver la correlaci√≥n de cada variable por especie. Dentro de `{GGally}` tenemos la siguiente funci√≥n:

```{r}
#| label: fig-correlation-heatmap3
#| fig-cap: Mapa de calor de correlaci√≥n por especie con `{GGally}`
ggpairs(
    data = iris,
    aes(color = Species)
) +
    theme_minimal(base_size = 8)
```

Madre m√≠a, pero esto qu√© es ü•µü§Ø !! Pues aqu√≠ tenemos varias cosas:

-   Colores: cada color representa una especie (rojo = setosa; verde = versicolor; azul = virginica)

-   Tri√°ngulo inferior: relaci√≥n de las variables mediante *scatter plots* para pares de variables num√©ricas e histogramas para 1 variable num√©rica y 1 variable categ√≥rica.

-   Diagonal: distribuci√≥n unitaria de cada variable. Gr√°ficos de densidad para num√©ricas, gr√°ficos de barras para variables categ√≥ricas.

-   Tri√°ngulo superior: valores de correlaci√≥n para pares de variables num√©ricas. *Boxplots* para 1 variable num√©rica y 1 variable categ√≥rica.

Como puedes ver, en b√°sicamente una l√≠nea de c√≥digo esta funci√≥n nos da una informaci√≥n MUY valiosa sobre nuestros datos. Esta funci√≥n la utilizo mucho durante el an√°lisis exploratorio de mis datos.
:::

### Ejercicio 9

Crear un gr√°fico de correlaci√≥n con `{GGally}` para los datos de inventario.

La estructura de los datos era la siguiente:

```{webr-r}
#| autorun: true
## Estructura datos
inventario_tbl
```

::: panel-tabset

## Gr√°fico esperado

El resultado esperado es el de la @fig-correlation-heatmap4. F√≠jate que no incluimos la variable `id_plots` en el gr√°fico.

Los colores utilizados son `cols <- c("#E56399", "#7F96FF")`. 

```{r}
#| echo: false
#| label: fig-correlation-heatmap-ej
#| fig-cap: Resultado esperado del ejercicio 9
## Colores
cols <- c("#E56399", "#7F96FF")
## Gr√°fico
inventario_tbl |> 
  select(-id_plots) |>
  ggpairs(
    aes(color = nombre_ifn)
  ) +
  scale_color_manual(
    values = cols
  ) +
  scale_fill_manual(
    values = cols
  ) +
  theme_minimal()
```

## Ejercicio

Replica el gr√°fico anterior e intenta entender qu√© ocurre en cada subgr√°fico.

```{webr-r}
## Escribe el c√≥digo aqu√≠
inventario_tbl
```

## Soluci√≥n

El resultado se muestra en la @fig-correlation-heatmap-sol. F√≠jate que tenemos que a√±adir tanto `scale_color_manual()` para cambiar los colores de los puntos y `scale_fill_manual()` para cambiar los de los rect√°ngulos.

```{r}
#| label: fig-correlation-heatmap-sol
#| fig-cap: Resultado final del ejercicio 9
## Colores
cols <- c("#E56399", "#7F96FF")
## Gr√°fico
inventario_tbl |> 
  select(-id_plots) |>
  ggpairs(
    aes(color = nombre_ifn)
  ) +
  scale_color_manual(
    values = cols
  ) +
  scale_fill_manual(
    values = cols
  ) +
  theme_minimal()
```

:::

Enhorabuena! Has llegado al final de este cap√≠tulo. S√© que ha sido intenso, pero estamos aprendiendo mucho. En el pr√≥ximo cap√≠tulo vamos a ver algunos gr√°ficos de comparaci√≥n.

## Resumen

En este cap√≠tulo hemos aprendido a crear gr√°ficos de dispersi√≥n y mapas de calor con `{ggplot2}`. Hemos aprendido a modificar las escalas de los ejes, a cambiar los colores de los puntos y a mover las leyendas. Adem√°s, hemos aprendido a crear mapas de calor de correlaci√≥n y a personalizarlos.
