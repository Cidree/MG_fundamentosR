{
  "hash": "0dea46041f07dd12d68be0b42f53c08c",
  "result": {
    "engine": "knitr",
    "markdown": "---\nexecute: \n  warning: false\neditor_options: \n  chunk_output_type: console\nfilters: \n    - webr\nwebr:\n    packages: [\"dplyr\", \"ggplot2\"]\n---\n\n\n\n\n# Gr√°ficos de relaci√≥n\n\nLos gr√°ficos de relaci√≥n son aquellos que nos permiten visualizar la relaci√≥n que tienen entre s√≠ dos o m√°s variables. Dentro de los gr√°ficos de relaci√≥n tambi√©n se puede denominar gr√°ficos de correlaci√≥n, y agrupan una familia m√°s grande que la que ve√≠amos en la @fig-vis-classification.\n\nEn este cap√≠tulo veremos los siguientes gr√°ficos de relaci√≥n:\n\n1.  Gr√°fico de dispersi√≥n (*Scatter plot*)\n\n2.  Gr√°fico de burbujas (*Bubble plot*)\n\n3.  Mapas de calor (*Heatmap*)\n\nEn este cap√≠tulo vamos a trabajar con tres *datasets*:\n\n-   `iris`: *dataset* donde se han medido la longitud y anchura de p√©talos y s√©palos de 150 flores, adem√°s de la especie a la que pertenecen (ver [Tipos de visualizaci√≥n](#sec-visualization-types){target=\"_blank\"}).\n\n-   `gapminder`: *dataset* con la evoluci√≥n temporal del desarrollo econ√≥mico, poblaci√≥n y esperanza de vida de los pa√≠ses del mundo (ver [Tipos de visualizaci√≥n](#sec-visualization-types){target=\"_blank\"}). Filtraremos solamente los datos del 2002.\n\n-   `inventario`: *dataset* con datos de inventario de 27 parcelas en los que se ha medido el DBH, altura y especie (ver @sec-vis-data).\n\nPara comenzar, vamos a cargar los paquetes necesarios y a leer los datos que utilizaremos en este cap√≠tulo.\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Cargar paquetes\nlibrary(gapminder)\nlibrary(GGally)\nlibrary(tidyverse)\n# Cargar datos\ninventario_tbl <- read_rds(\"data/inventario_prep.rds\")\ngapminder_tbl <- gapminder |> \n    filter(year == 2002)\n```\n:::\n\n\n\n\n## Objetivos\n\nAl final de este cap√≠tulo ser√°s capaz de:\n\n-   Utilizar un tema distinto por defecto\n\n-   Crear gr√°ficos de dispersi√≥n y burbujas\n\n-   Crear mapas de calor\n\n-   Crear gr√°ficos de correlaci√≥n\n\n-   A√±adir texto como geometr√≠a a los gr√°ficos\n\n-   Controlar colores utilizando `scales`\n\n-   Mover la leyenda\n\n## Gr√°ficos de dispersi√≥n\n\nAntes de empezar, vamos a ver como modificar el tema que viene por defecto en `{ggplot2}`, para que no tengamos que a√±adirlo en cada gr√°fico que hagamos.\n\nUtilizando la funci√≥n `theme_set()` podemos establecer un tema por defecto para todos los gr√°ficos que hagamos en el documento. En este caso, hemos seleccionado el tema `theme_classic()`, que es uno de los temas m√°s utilizados en `{ggplot2}`.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntheme_set(\n    theme_classic()\n)\n```\n:::\n\n\n\n\nLos gr√°ficos de dispersi√≥n son una de las formas m√°s comunes de visualizar la relaci√≥n entre dos **variables num√©ricas**. En un gr√°fico de dispersi√≥n, cada punto representa una observaci√≥n y se coloca en el eje `x` seg√∫n el valor de la primera variable y en el eje `y` seg√∫n el valor de la segunda variable.\n\nPara crear un gr√°fico de dispersi√≥n en `ggplot2` se utiliza la funci√≥n `geom_point()`. A continuaci√≥n, se muestra un ejemplo de c√≥mo crear un gr√°fico de dispersi√≥n utilizando el *dataset* `gapminder` relacionando el PIB per c√°pita con la esperanza de vida, y coloreando los puntos seg√∫n el continente.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Crear gr√°fico\nbase_scatter_gg <- gapminder_tbl |> \n    ggplot(\n        aes(x = gdpPercap, y = lifeExp, color = continent)\n    ) +\n    geom_point(\n        size = 2\n    ) +\n    labs(\n        x = \"PIB per c√°pita\",\n        y = \"Esperanza de vida\"\n    )\n## Imprimir\nbase_scatter_gg\n```\n\n::: {.cell-output-display}\n![Gr√°fico de dispersi√≥n con ggplot2](1103_relationship_files/figure-html/fig-dispersion-scatter-1.png){#fig-dispersion-scatter width=672}\n:::\n:::\n\n\n\n\nF√≠jate que como hemos utilizado `theme_set()` al principio del documento, no hemos tenido que a√±adir `theme_classic()` en el gr√°fico.\n\nPues as√≠ de sencillo es crear un gr√°fico de dispersi√≥n en `ggplot2`. Como ya estamos familiarizados con la funcionalidad b√°sica, vamos a aprender a cambiar los colores de los puntos y a mover la leyenda.\n\nVamos a empezar modificando los colores de cada uno de los continentes para que sean:\n\n-   `√Åfrica`: naranja\n\n-   `Am√©rica`: negro\n\n-   `Asia`: lila\n\n-   `Europa`: azul\n\n-   `Ocean√≠a`: verde\n\nSi record√°is, en la @sec-components-scales ve√≠amos que las variables num√©ricas traen por defecto una escala continua (i.e. `scale_*_continuous()`) y las variables categ√≥ricas una escala de discreta (i.e. `scale_*_discrete()`).\n\nEn este caso, queremos cambiar los colores de las especies, y para ello tenemos que modificar la escala a `manual` con la funci√≥n `scale_color_manual()`. A continuaci√≥n, se muestra el c√≥digo para cambiar los colores de las especies:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Crear gr√°fico\nscales_scatter_gg <- base_scatter_gg +\n    scale_color_manual(\n        name   = \"Continente\",\n        values = c(\"#FF5733\", \"black\", \"#A833FF\", \"#3366FF\", \"#33FF57\")\n    )\n## Imprimir\nscales_scatter_gg\n```\n\n::: {.cell-output-display}\n![Gr√°fico de dispersi√≥n con ggplot2](1103_relationship_files/figure-html/fig-dispersion-scatter-colors-1.png){#fig-dispersion-scatter-colors width=672}\n:::\n:::\n\n\n\n\nCon el argumento `name` de las funciones `scale*` podemos cambiar el nombre de la leyenda, y en `values` tenemos que especificar un vector con los colores que queremos asignar a cada categor√≠a.\n\n::: callout-note\nEn @fig-dispersion-scatter-colors hemos asignado a `values` un vector de longitud 5 porque tenemos 5 categor√≠as (1 por continente). Si asignamos m√°s colores de los necesarios, la funci√≥n los ignorar√°, mientras que si asignamos menos, la funci√≥n nos dar√° el error: *`Insufficient values in manual scale`*\n:::\n\nLo siguiente que vamos a aprender es a mover la leyenda. Aqu√≠ tenemos dos opciones:\n\n-   Utilizar una posici√≥n relativa al gr√°fico\n\n-   Utilizar una posici√≥n absoluta dentro del gr√°fico\n\nVamos a utilizar el m√©todo introducido en la versi√≥n 3.5.0 de `{ggplot2}` que es el siguiente:\n\n::: panel-tabset\n## Posici√≥n relativa\n\nLa posici√≥n relativa es la m√°s sencilla. La forma **recomendable** es la siguiente, ya que si tuvi√©ramos m√°s de una leyenda, podr√≠amos controlar la posici√≥n de cada una dentro de `guides`.\n\nLo que estamos haciendo es: (1) utilizar la funci√≥n `guides`; (2) como argumento utilizar el nombre la est√©tica de la leyenda que queremos modificar (`color`); (3) utilizar la funci√≥n `guide_legend()` que tiene muchos argumentos para modificar la leyenda.\n\n```{shinylive-r}\n#| standalone: true\n#| viewerHeight: 600\n\n## Load packages\nlibrary(bslib)\nlibrary(dplyr)\nlibrary(gapminder)\nlibrary(ggplot2)\nlibrary(glue)\nlibrary(shiny)\n\n## UI\nui <- page_sidebar(\n    sidebar = sidebar(\n        open = \"open\",\n        width = 200,\n        selectInput(\n            inputId = \"position_input\", \n            label   = \"Posici√≥n\", \n            choices = c(\"bottom\", \"top\", \"left\", \"right\", \"inside\"),\n        )\n    ),\n    verbatimTextOutput(\"code\") |> card(),\n    plotOutput(\"plot\", width = 500) |> card()\n)\n\n## Server\nserver <- function(input, output, session) {\n    \n    output$code <- renderPrint({\n        glue(\n            '\n            scales_scatter_gg +\n                guides(\n                    color = guide_legend(\n                        position = \"{input$position_input}\"\n                    )\n                )'\n            )\n    })\n\n    ## Plot\n    output$plot <- renderPlot({\n        gapminder |> \n            filter(year == 2002) |> \n            ggplot(\n                aes(x = gdpPercap, y = lifeExp, color = continent)\n            ) +\n            geom_point(\n                size = 2\n            ) +\n            labs(\n                x = \"PIB per c√°pita\",\n                y = \"Esperanza de vida\"\n            ) +\n            scale_color_manual(\n                name   = \"Continente\",\n                values = c(\"#FF5733\", \"black\", \"#A833FF\", \"#3366FF\", \"#33FF57\")\n            ) +\n            guides(\n                color = guide_legend(\n                    position = {input$position_input}\n                )\n            ) +\n            theme_bw(base_size = 8)\n        }, res = 96\n    )\n}\n\n## Run app\nshinyApp(ui = ui, server = server)\n```\n\n## Posici√≥n absoluta\n\nPara la posici√≥n absoluta, debemos utilizar `position = \"inside\"`. Una vez hecho esto, debemos modificar el argumento `legend.position.inside` dentro de la funci√≥n `theme()` indicar un vector num√©rico de longitud 2, donde el primer n√∫mero indica el % de desplazamiento sobre el eje `x` desde el origen, mientras que el segundo n√∫mero indica el % de desplazamiento sobre el eje `y`. Prueba a cambiar los valores en la siguiente aplicaci√≥n para entender su funcionamiento:\n\n```{shinylive-r}\n#| standalone: true\n#| viewerHeight: 600\n\n## Load packages\nlibrary(bslib)\nlibrary(dplyr)\nlibrary(gapminder)\nlibrary(ggplot2)\nlibrary(glue)\nlibrary(shiny)\n\n## UI\nui <- page_sidebar(\n    sidebar = sidebar(\n        open = \"open\",\n        width = 200,\n        sliderInput(\n            inputId = \"position_input_x\", \n            label   = \"Posici√≥n eje x\",\n            min     = 0,\n            max     = 1,\n            value   = 0.5,\n            step    = 0.1\n        ),\n        sliderInput(\n            inputId = \"position_input_y\", \n            label   = \"Posici√≥n eje y\",\n            min     = 0,\n            max     = 1,\n            value   = 0.5,\n            step    = 0.1\n        )\n    ),\n    verbatimTextOutput(\"code\") |> card(),\n    plotOutput(\"plot\", width = 500) |> card()\n)\n\n## Server\nserver <- function(input, output, session) {\n    \n    output$code <- renderPrint({\n        glue(\n            '\n            scales_scatter_gg +\n                guides(\n                    color = guide_legend(\n                        position = \"inside\"\n                    )\n                ) +\n                theme(\n                    legend.position.inside = c({input$position_input_x}, {input$position_input_y})'\n            )\n    })\n\n    ## Plot\n    output$plot <- renderPlot({\n        gapminder |> \n            filter(year == 2002) |> \n            ggplot(\n                aes(x = gdpPercap, y = lifeExp, color = continent)\n            ) +\n            geom_point(\n                size = 2\n            ) +\n            labs(\n                x = \"PIB per c√°pita\",\n                y = \"Esperanza de vida\"\n            ) +\n            scale_color_manual(\n                name   = \"Continente\",\n                values = c(\"#FF5733\", \"black\", \"#A833FF\", \"#3366FF\", \"#33FF57\")\n            ) +\n            guides(\n                color = guide_legend(\n                    position = \"inside\"\n                )\n            ) +\n            theme_bw(base_size = 8) +\n            theme(\n                legend.position.inside = c(input$position_input_x, input$position_input_y))\n            }, res = 96\n    )\n}\n\n## Run app\nshinyApp(ui = ui, server = server)\n```\n:::\n\n## Gr√°ficos de burbujas\n\nLos gr√°ficos de burbujas son una extensi√≥n de los gr√°ficos de dispersi√≥n, donde se a√±ade una **tercera variable num√©rica** que se representa mediante el tama√±o de los puntos.\n\n::: callout-note\nEn la pr√°ctica, si utilizamos las est√©ticas de `color` y `size`, estamos visualizando 4 variables num√©ricas al mismo tiempo!!\n:::\n\nEn `ggplot2`, podemos a√±adir una tercera variable utilizando la est√©tica `size` en la funci√≥n `aes()`. Al *scatter plot* anterior, vamos a a√±adirle como variable de `size` la poblaci√≥n. Como vamos a a√±adir nuevos elementos, vamos a a√±adir el c√≥digo paso a paso:\n\n::: panel-tabset\n## 1. Bubble plot\n\nEmpezamos generando un *bubble plot* a√±adiendo la variable *pop:*\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Crear gr√°fico\nbubble_base <- gapminder_tbl |> \n    ggplot(\n        aes(x = gdpPercap, y = lifeExp, color = continent, size = pop)\n    ) +\n    geom_point(\n        alpha = 0.7\n    ) +\n    labs(\n        x = \"PIB per c√°pita\",\n        y = \"Esperanza de vida\"\n    ) +\n    scale_color_manual(\n        name   = \"Continente\",\n        values = c(\"#FF5733\", \"black\", \"#A833FF\", \"#3366FF\", \"#33FF57\")\n    )\n## Imprimir\nbubble_base\n```\n\n::: {.cell-output-display}\n![](1103_relationship_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n\n\n## 2. Tama√±o puntos\n\nEl tama√±o de los puntos al igual que el color de los mismos es una est√©tica. Para modificar una est√©tica mapeada a una variable utilizamos las funciones `scale_*`. Como la est√©tica es `size`, utilizamos `scale_size*()`. En el argumento `range` indicamos el tama√±o del punto m√°s peque√±o y el tama√±o del punto m√°s grande:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Crear gr√°fico\nbubble_size <- bubble_base +\n    scale_size(range = c(1, 15))\n## Imprimir\nbubble_size\n```\n\n::: {.cell-output-display}\n![](1103_relationship_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n\n\n## 3. Eliminar una leyenda\n\nRecuerdas la funci√≥n `guides` que vimos antes? Si igualamos una de las est√©ticas a `\"none\"` eliminaremos solamente esa leyenda:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Crear gr√°fico\nbubble_guides <- bubble_size +\n    guides(\n        size = \"none\"\n    )\n## Imprimir\nbubble_guides\n```\n\n::: {.cell-output-display}\n![](1103_relationship_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n\n\n## 4. Posicionar leyenda\n\nPara terminar, vamos a posicionar la leyenda del continente en la parte inferior derecha del gr√°fico para aprovechar el espacio:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Crear gr√°fico\nbubble_final <- bubble_guides +\n    guides(\n        color = guide_legend(\n            position = \"inside\"\n        )\n    ) +\n    theme(\n        legend.position.inside = c(.9, .2)\n    ) \n## Imprimir\nbubble_final\n```\n\n::: {.cell-output-display}\n![](1103_relationship_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n\n\n## 5. Resumen\n\nEste gr√°fico nos muestra que los pa√≠ses con menor PIB per c√°pita son tambi√©n aquellos con generalmente menor esperanza de vida y se encuentran principalmente en √Åfrica.\n\nPara terminar, vamos a ver como se ver√≠a todo el c√≥digo en un solo bloque:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngapminder_tbl |> \n    ## Capas\n    ggplot(\n        aes(x = gdpPercap, y = lifeExp, color = continent, size = pop)\n    ) +\n    geom_point(\n        alpha = 0.7\n    ) +\n    ## Etiquetas\n    labs(\n        x = \"PIB per c√°pita\",\n        y = \"Esperanza de vida\"\n    ) +\n    ## Escalas y gu√≠as\n    scale_color_manual(\n        name   = \"Continente\",\n        values = c(\"#FF5733\", \"black\", \"#A833FF\", \"#3366FF\", \"#33FF57\")\n    ) +\n    scale_size(range = c(1, 15)) +\n    guides(\n        size  = \"none\",\n        color = guide_legend(\n            position = \"inside\"\n        )\n    ) +\n    ## Temas\n    theme(\n        legend.position.inside = c(.9, .2)\n    ) \n```\n\n::: {.cell-output-display}\n![](1103_relationship_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\n\n:::\n\nUff üò•... Si es tu primera vez estudiando `{ggplot2}` es posible que te est√© explotando la cabeza. No te preocupes!! Es normal que al principio te cueste, pero poco a poco iremos domin√°ndolo juntosüòé.\n\n### Ejercicio 7\n\nEs hora de ponerse manos a la obra! El objetivo del siguiente ejercicio es replicar el siguiente gr√°fico con el *dataset* de `iris`. Recuerda la estructura de los datos:\n\n\n\n\n::: {#tbl-iris-head .cell tbl-cap='Estructura de los datos de Iris'}\n::: {.cell-output-display}\n\n```{=html}\n<div id=\"yzjjntieml\" style=\"padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;\">\n<style>#yzjjntieml table {\n  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n}\n\n#yzjjntieml thead, #yzjjntieml tbody, #yzjjntieml tfoot, #yzjjntieml tr, #yzjjntieml td, #yzjjntieml th {\n  border-style: none;\n}\n\n#yzjjntieml p {\n  margin: 0;\n  padding: 0;\n}\n\n#yzjjntieml .gt_table {\n  display: table;\n  border-collapse: collapse;\n  line-height: normal;\n  margin-left: auto;\n  margin-right: auto;\n  color: #333333;\n  font-size: 16px;\n  font-weight: normal;\n  font-style: normal;\n  background-color: #FFFFFF;\n  width: auto;\n  border-top-style: solid;\n  border-top-width: 3px;\n  border-top-color: #D5D5D5;\n  border-right-style: solid;\n  border-right-width: 3px;\n  border-right-color: #D5D5D5;\n  border-bottom-style: solid;\n  border-bottom-width: 3px;\n  border-bottom-color: #D5D5D5;\n  border-left-style: solid;\n  border-left-width: 3px;\n  border-left-color: #D5D5D5;\n}\n\n#yzjjntieml .gt_caption {\n  padding-top: 4px;\n  padding-bottom: 4px;\n}\n\n#yzjjntieml .gt_title {\n  color: #333333;\n  font-size: 125%;\n  font-weight: initial;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-color: #FFFFFF;\n  border-bottom-width: 0;\n}\n\n#yzjjntieml .gt_subtitle {\n  color: #333333;\n  font-size: 85%;\n  font-weight: initial;\n  padding-top: 3px;\n  padding-bottom: 5px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-color: #FFFFFF;\n  border-top-width: 0;\n}\n\n#yzjjntieml .gt_heading {\n  background-color: #FFFFFF;\n  text-align: center;\n  border-bottom-color: #FFFFFF;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#yzjjntieml .gt_bottom_border {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D5D5D5;\n}\n\n#yzjjntieml .gt_col_headings {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D5D5D5;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D5D5D5;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n}\n\n#yzjjntieml .gt_col_heading {\n  color: #FFFFFF;\n  background-color: #004D80;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 6px;\n  padding-left: 5px;\n  padding-right: 5px;\n  overflow-x: hidden;\n}\n\n#yzjjntieml .gt_column_spanner_outer {\n  color: #FFFFFF;\n  background-color: #004D80;\n  font-size: 100%;\n  font-weight: normal;\n  text-transform: inherit;\n  padding-top: 0;\n  padding-bottom: 0;\n  padding-left: 4px;\n  padding-right: 4px;\n}\n\n#yzjjntieml .gt_column_spanner_outer:first-child {\n  padding-left: 0;\n}\n\n#yzjjntieml .gt_column_spanner_outer:last-child {\n  padding-right: 0;\n}\n\n#yzjjntieml .gt_column_spanner {\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D5D5D5;\n  vertical-align: bottom;\n  padding-top: 5px;\n  padding-bottom: 5px;\n  overflow-x: hidden;\n  display: inline-block;\n  width: 100%;\n}\n\n#yzjjntieml .gt_spanner_row {\n  border-bottom-style: hidden;\n}\n\n#yzjjntieml .gt_group_heading {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D5D5D5;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D5D5D5;\n  border-left-style: none;\n  border-left-width: 1px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 1px;\n  border-right-color: #D3D3D3;\n  vertical-align: middle;\n  text-align: left;\n}\n\n#yzjjntieml .gt_empty_group_heading {\n  padding: 0.5px;\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D5D5D5;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D5D5D5;\n  vertical-align: middle;\n}\n\n#yzjjntieml .gt_from_md > :first-child {\n  margin-top: 0;\n}\n\n#yzjjntieml .gt_from_md > :last-child {\n  margin-bottom: 0;\n}\n\n#yzjjntieml .gt_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  margin: 10px;\n  border-top-style: solid;\n  border-top-width: 1px;\n  border-top-color: #D5D5D5;\n  border-left-style: solid;\n  border-left-width: 1px;\n  border-left-color: #D5D5D5;\n  border-right-style: solid;\n  border-right-width: 1px;\n  border-right-color: #D5D5D5;\n  vertical-align: middle;\n  overflow-x: hidden;\n}\n\n#yzjjntieml .gt_stub {\n  color: #FFFFFF;\n  background-color: #929292;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D5D5D5;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#yzjjntieml .gt_stub_row_group {\n  color: #333333;\n  background-color: #FFFFFF;\n  font-size: 100%;\n  font-weight: initial;\n  text-transform: inherit;\n  border-right-style: solid;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n  padding-left: 5px;\n  padding-right: 5px;\n  vertical-align: top;\n}\n\n#yzjjntieml .gt_row_group_first td {\n  border-top-width: 2px;\n}\n\n#yzjjntieml .gt_row_group_first th {\n  border-top-width: 2px;\n}\n\n#yzjjntieml .gt_summary_row {\n  color: #FFFFFF;\n  background-color: #5F5F5F;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#yzjjntieml .gt_first_summary_row {\n  border-top-style: solid;\n  border-top-color: #D5D5D5;\n}\n\n#yzjjntieml .gt_first_summary_row.thick {\n  border-top-width: 2px;\n}\n\n#yzjjntieml .gt_last_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D5D5D5;\n}\n\n#yzjjntieml .gt_grand_summary_row {\n  color: #FFFFFF;\n  background-color: #929292;\n  text-transform: inherit;\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#yzjjntieml .gt_first_grand_summary_row {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-top-style: double;\n  border-top-width: 6px;\n  border-top-color: #D5D5D5;\n}\n\n#yzjjntieml .gt_last_grand_summary_row_top {\n  padding-top: 8px;\n  padding-bottom: 8px;\n  padding-left: 5px;\n  padding-right: 5px;\n  border-bottom-style: double;\n  border-bottom-width: 6px;\n  border-bottom-color: #D5D5D5;\n}\n\n#yzjjntieml .gt_striped {\n  background-color: #F4F4F4;\n}\n\n#yzjjntieml .gt_table_body {\n  border-top-style: solid;\n  border-top-width: 2px;\n  border-top-color: #D5D5D5;\n  border-bottom-style: solid;\n  border-bottom-width: 2px;\n  border-bottom-color: #D5D5D5;\n}\n\n#yzjjntieml .gt_footnotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#yzjjntieml .gt_footnote {\n  margin: 0px;\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#yzjjntieml .gt_sourcenotes {\n  color: #333333;\n  background-color: #FFFFFF;\n  border-bottom-style: none;\n  border-bottom-width: 2px;\n  border-bottom-color: #D3D3D3;\n  border-left-style: none;\n  border-left-width: 2px;\n  border-left-color: #D3D3D3;\n  border-right-style: none;\n  border-right-width: 2px;\n  border-right-color: #D3D3D3;\n}\n\n#yzjjntieml .gt_sourcenote {\n  font-size: 90%;\n  padding-top: 4px;\n  padding-bottom: 4px;\n  padding-left: 5px;\n  padding-right: 5px;\n}\n\n#yzjjntieml .gt_left {\n  text-align: left;\n}\n\n#yzjjntieml .gt_center {\n  text-align: center;\n}\n\n#yzjjntieml .gt_right {\n  text-align: right;\n  font-variant-numeric: tabular-nums;\n}\n\n#yzjjntieml .gt_font_normal {\n  font-weight: normal;\n}\n\n#yzjjntieml .gt_font_bold {\n  font-weight: bold;\n}\n\n#yzjjntieml .gt_font_italic {\n  font-style: italic;\n}\n\n#yzjjntieml .gt_super {\n  font-size: 65%;\n}\n\n#yzjjntieml .gt_footnote_marks {\n  font-size: 75%;\n  vertical-align: 0.4em;\n  position: initial;\n}\n\n#yzjjntieml .gt_asterisk {\n  font-size: 100%;\n  vertical-align: 0;\n}\n\n#yzjjntieml .gt_indent_1 {\n  text-indent: 5px;\n}\n\n#yzjjntieml .gt_indent_2 {\n  text-indent: 10px;\n}\n\n#yzjjntieml .gt_indent_3 {\n  text-indent: 15px;\n}\n\n#yzjjntieml .gt_indent_4 {\n  text-indent: 20px;\n}\n\n#yzjjntieml .gt_indent_5 {\n  text-indent: 25px;\n}\n</style>\n<table class=\"gt_table\" data-quarto-disable-processing=\"false\" data-quarto-bootstrap=\"false\">\n  <thead>\n    <tr class=\"gt_col_headings\">\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"Sepal.Length\">Sepal.Length</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"Sepal.Width\">Sepal.Width</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"Petal.Length\">Petal.Length</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_right\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"Petal.Width\">Petal.Width</th>\n      <th class=\"gt_col_heading gt_columns_bottom_border gt_center\" rowspan=\"1\" colspan=\"1\" scope=\"col\" id=\"Species\">Species</th>\n    </tr>\n  </thead>\n  <tbody class=\"gt_table_body\">\n    <tr><td headers=\"Sepal.Length\" class=\"gt_row gt_right\">5.1</td>\n<td headers=\"Sepal.Width\" class=\"gt_row gt_right\">3.5</td>\n<td headers=\"Petal.Length\" class=\"gt_row gt_right\">1.4</td>\n<td headers=\"Petal.Width\" class=\"gt_row gt_right\">0.2</td>\n<td headers=\"Species\" class=\"gt_row gt_center\">setosa</td></tr>\n    <tr><td headers=\"Sepal.Length\" class=\"gt_row gt_right gt_striped\">4.9</td>\n<td headers=\"Sepal.Width\" class=\"gt_row gt_right gt_striped\">3.0</td>\n<td headers=\"Petal.Length\" class=\"gt_row gt_right gt_striped\">1.4</td>\n<td headers=\"Petal.Width\" class=\"gt_row gt_right gt_striped\">0.2</td>\n<td headers=\"Species\" class=\"gt_row gt_center gt_striped\">setosa</td></tr>\n    <tr><td headers=\"Sepal.Length\" class=\"gt_row gt_right\">4.7</td>\n<td headers=\"Sepal.Width\" class=\"gt_row gt_right\">3.2</td>\n<td headers=\"Petal.Length\" class=\"gt_row gt_right\">1.3</td>\n<td headers=\"Petal.Width\" class=\"gt_row gt_right\">0.2</td>\n<td headers=\"Species\" class=\"gt_row gt_center\">setosa</td></tr>\n    <tr><td headers=\"Sepal.Length\" class=\"gt_row gt_right gt_striped\">4.6</td>\n<td headers=\"Sepal.Width\" class=\"gt_row gt_right gt_striped\">3.1</td>\n<td headers=\"Petal.Length\" class=\"gt_row gt_right gt_striped\">1.5</td>\n<td headers=\"Petal.Width\" class=\"gt_row gt_right gt_striped\">0.2</td>\n<td headers=\"Species\" class=\"gt_row gt_center gt_striped\">setosa</td></tr>\n    <tr><td headers=\"Sepal.Length\" class=\"gt_row gt_right\">5.0</td>\n<td headers=\"Sepal.Width\" class=\"gt_row gt_right\">3.6</td>\n<td headers=\"Petal.Length\" class=\"gt_row gt_right\">1.4</td>\n<td headers=\"Petal.Width\" class=\"gt_row gt_right\">0.2</td>\n<td headers=\"Species\" class=\"gt_row gt_center\">setosa</td></tr>\n    <tr><td headers=\"Sepal.Length\" class=\"gt_row gt_right gt_striped\">5.4</td>\n<td headers=\"Sepal.Width\" class=\"gt_row gt_right gt_striped\">3.9</td>\n<td headers=\"Petal.Length\" class=\"gt_row gt_right gt_striped\">1.7</td>\n<td headers=\"Petal.Width\" class=\"gt_row gt_right gt_striped\">0.4</td>\n<td headers=\"Species\" class=\"gt_row gt_center gt_striped\">setosa</td></tr>\n  </tbody>\n  \n  \n</table>\n</div>\n```\n\n:::\n:::\n\n\n\n\n::: panel-tabset\n## Gr√°fico esperado\n\nIntenta replicar este gr√°fico en la pesta√±a \"Ejercicio\"\n\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Resultado esperado del ejercicio 7](1103_relationship_files/figure-html/fig-distribution-ej7-1.png){#fig-distribution-ej7 width=672}\n:::\n:::\n\n\n\n\n## Ejercicio\n\nCompletar el c√≥digo:\n\n```{webr-r}\niris |> \n    ## Introducir c√≥digo\n    labs(\n        title = \"Relaci√≥n entre longitud de p√©talo, anchura de p√©talo y longitud de s√©palo\",\n        x = \"Longitud de p√©talo (mm)\",\n        y = \"Anchura de p√©talo (mm)\"\n    ) \n```\n\n## Soluci√≥n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\niris |> \n    ggplot(\n        aes(\n            x = Petal.Length, \n            y = Petal.Width,\n            color = Species,\n            size  = Sepal.Length\n        )\n    ) +\n    geom_point() +\n    labs(\n        title = \"Relaci√≥n entre longitud de p√©talo, anchura de p√©talo y longitud de s√©palo\",\n        x = \"Longitud de p√©talo (mm)\",\n        y = \"Anchura de p√©talo (mm)\"\n    ) +\n    scale_color_manual(\n        name   = \"Especies\",\n        values = c(\"#FF6347\", \"#4682B4\", \"#32CD32\")\n    ) +\n    scale_size(range = c(1, 5)) +\n    guides(\n        size = \"none\",\n        color = guide_legend(position = \"inside\")\n    ) +\n    theme(\n        legend.position.inside = c(.1, .8)\n    )\n```\n\n::: {.cell-output-display}\n![Soluci√≥n del ejercicio 7](1103_relationship_files/figure-html/fig-distribution-ej7-sol-1.png){#fig-distribution-ej7-sol width=672}\n:::\n:::\n\n\n\n:::\n\n## Mapas de calor\n\nDentro de los mapas de calor voy a hacer una clasificaci√≥n para entender sus dos principales usos:\n\n1.  **Mapa de calor cl√°sico**: El primero ser√° un mapa de calor donde comparamos el valor de una variable num√©rica (o una categ√≥rica) **en funci√≥n de dos variables categ√≥ricas**.\n\n2.  **Mapa de calor de correlaci√≥n**: El segundo ser√° un mapa de calor donde comparamos la **correlaci√≥n** entre las variables num√©ricas de un *dataset*.\n\n::: calllout-note\nEsta nomenclatura es propia y no tiene por qu√© ser la misma que se utiliza en la literatura.\n:::\n\n### Mapa de calor cl√°sico\n\nLos mapas de calor son una forma de visualizar la relaci√≥n entre las categor√≠as de dos variables categ√≥ricas y una variable num√©rica (o otra categ√≥rica). Las categor√≠as de las variables categ√≥ricas se representan en los ejes `x` e `y`, y la variable num√©rica se representa mediante el color de las celdas.\n\n::: callout-note\nExisten tres funciones en `ggplot2` que nos permiten crear mapas de calor: `geom_tile()`, `geom_raster()` y `geom_rect()`.\n:::\n\nVamos a ver la evoluci√≥n de la esperanza de vida en los pa√≠ses de Europa a lo largo de los a√±os. Para ello, vamos a utilizar el *dataset* `gapminder` y filtrar los datos de Europa:\n\n::: panel-tabset\n## Primer heatmap\n\nPara crear el primer *heatmap* vamos a utilizar la funci√≥n `geom_tile()`. En el eje `x` utilizamos los a√±os, en el eje `y` los pa√≠ses europeos, y como esta geometr√≠a dibuja pol√≠gonos, los coloreamos con la est√©tica `fill`:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngapminder |> \n    filter(continent == \"Europe\") |> \n    ## Crear gr√°fico\n    ggplot(\n        aes(x = year, y = country, fill = lifeExp)\n    ) +\n    geom_tile() +\n    labs(\n      x = NULL,\n      y = NULL,\n      fill = \"Esperanza de vida\"\n    )\n```\n\n::: {.cell-output-display}\n![Primer mapa de calor con `{ggplot2}`](1103_relationship_files/figure-html/fig-heatmap-1.png){#fig-heatmap width=672}\n:::\n:::\n\n\n\n\nComo primer intento est√° bien... Pero puedes ver lo que ocurre en el eje `x`? Los a√±os son n√∫meros s√≠, pero son una variable categ√≥rica en esto datos. Tenemos un n√∫mero peque√±o de a√±os que queremos tratar como categor√≠as, no como n√∫meros.\n\n::: callout-tip\nPuedes ver que para eliminar los t√≠tulos de los ejes utilizamos `y = NULL` y `x = NULL`.\n:::\n\n## Convertir a√±os\n\nRecuerdas c√≥mo hac√≠amos para convertir una variable a categ√≥rica? Exacto, utilizamos la funci√≥n `as.factor()`, que adem√°s es muy conveniente ya que ordena los niveles de la variable alfab√©ticamente:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngapminder |> \n    filter(continent == \"Europe\") |> \n    mutate(\n        year = as.factor(year)\n    ) |> \n    ## Crear gr√°fico\n    ggplot(\n        aes(x = year, y = country, fill = lifeExp)\n    ) +\n    geom_tile() +\n    labs(\n      x = NULL,\n      y = NULL,\n      fill = \"Esperanza de vida\"\n    )\n```\n\n::: {.cell-output-display}\n![Segundo mapa de calor con `{ggplot2}`](1103_relationship_files/figure-html/fig-heatmap2-1.png){#fig-heatmap2 width=672}\n:::\n:::\n\n\n\n\nSolucionado! Ahora ya sabemos a qu√© a√±o pertenece cada celda. Vamos a intentar formatear un poco m√°s el gr√°fico... Vamos a utilizar una paleta de colores adecuada y ordenar los pa√≠ses para que Albania sea el primero en la parte superior.\n\n## Personalizar\n\nEn la @fig-heatmap3 se muestra el resultado final. Vamos a ver lo que hemos hecho:\n\n-   Hemos ordenado los pa√≠ses utilizando la funci√≥n `fct_rev()` del paquete `{forcats}`. Esta funci√≥n invierte el orden de los factores.\n\n-   Hemos utilizado la paleta de colores [viridis](https://cran.r-project.org/web/packages/viridis/vignettes/intro-to-viridis.html) con la funci√≥n `scale_fill_viridis_c()`. Utilizamos `scale_fill_*`, porque la est√©tica que modificamos es `fill`. A continuaci√≥n, a√±adimos `scale_fill_viridis_*` que es una funci√≥n que tiene unas paletas de colores muy utilizadas y viene implementada en `{ggplot2}`, y finalmente a√±adimos la `c`, que quiere decir que la variable de la est√©tica `fill` es una variable **c**ontinua.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngapminder |> \n  filter(continent == \"Europe\") |> \n  mutate(\n      year = as.factor(year)\n  ) |> \n  ggplot(\n      aes(x = year, y = fct_rev(country), fill = lifeExp)\n  ) +\n  geom_tile() +\n  labs(\n    x = NULL,\n    y = NULL,\n    fill = \"Esperanza de vida\"\n  ) +\n  scale_fill_viridis_c() +\n  theme_minimal() \n```\n\n::: {.cell-output-display}\n![Mapa de calor personalizado](1103_relationship_files/figure-html/fig-heatmap3-1.png){#fig-heatmap3 width=672}\n:::\n:::\n\n\n\n\n## Etiquetas\n\nAlgo com√∫n en los mapas de calor es presentarlos como tablas de colores, donde no solamente tenemos las celdas de colores, si no tambi√©n el dato real que representan. Para a√±adirlos, vamos a a√±adir un nueva geometr√≠a que es `geom_text()`, que tiene 3 est√©ticas obligatorias: `x`, `y` y `label`. Las dos primeras ser√°n la posici√≥n de la etiqueta, y `label` ser√° el texto que se muestra:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngapminder |> \n    filter(continent == \"Europe\") |> \n    mutate(\n        year    = as.factor(year),\n        lifeExp = round(lifeExp, 1)\n    ) |> \n    ggplot(\n        aes(x = year, y = fct_rev(country))\n    ) +\n    geom_tile(\n        aes(fill = lifeExp),\n        show.legend = FALSE\n    ) +\n    geom_text(\n        aes(label = lifeExp),\n        size = 2.5\n    ) +\n    labs(\n        x = NULL,\n        y = NULL,\n        title = \"La esperanza de vida en los pa√≠ses europeos aument√≥ considerablemente\"\n    ) +\n    scale_fill_gradientn(\n        colours = hcl.colors(10, \"Blues\", rev = TRUE)\n    ) +\n    theme_minimal() +\n    theme(\n        plot.title = element_text(\n            size  = 10,\n            face  = \"bold\", \n            hjust = .5\n        )\n    )\n```\n\n::: {.cell-output-display}\n![Heatmap con etiquetas](1103_relationship_files/figure-html/fig-heatmap4-1.png){#fig-heatmap4 width=672}\n:::\n:::\n\n\n\n\nHemos a√±adido `scale_fill_grandientn()` que es el equivalente a `scale_fill_manual()` para variables continuas. La funci√≥n `hcl.colors()` simplemente nos devuelve un vector de colores:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"false\"}\nhcl.colors(10, \"Blues\", rev = T)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n [1] \"#F4FAFE\" \"#E1F0F8\" \"#C8DFEE\" \"#ACCCE4\" \"#8FB7D9\" \"#709FCD\" \"#5087C1\"\n [8] \"#316DB3\" \"#305292\" \"#273871\"\n```\n\n\n:::\n:::\n\n\n\n\nF√≠jate que tambi√©n hemos movido `aes(fill = lifeExp)`. Se te ocurre por qu√© puede ser esto? Dentro de `ggplot()` introducimos las est√©ticas que queremos que hereden el resto de geometr√≠as, y `fill` solamente la queremos para `geom_tile()` mientras que `label` solamente la queremos para `geom_text()`.\n\nY finalmente, modificamos el t√≠tulo del gr√°fico para reducir su tama√±o base, ponerlo en negrita y justificarlo en el medio. No te preocupes si la sintaxis de la componente `theme()` te parece extra√±a, nos iremos familiarizando con ella poco a poco.\n:::\n\nY con esto hemos visto el primer tipo de de *heatmaps*. Vamos a realizar un ejercicio utilizando los datos de inventario:\n\n### Ejercicio 8\n\nUtilizar de nuevo los datos de inventario para generar un *heatmap* donde se muestre el **DBH medio por parcela y especie**. Ten en cuenta que debes calcularlo. En la pesta√±a \"Pista\" tendr√°s la parte que genera estos datos, y que ser√°n los datos que utilizar√°s en `ggplot()`.\n\nLa estructura de los datos era la siguiente:\n\n```{webr-r}\n#| context: setup\n#| autorun: true\n## Url de los datos\nurl <- \"https://cidree.github.io/MG_datasets/inventario_prep.csv\"\ninventario_tbl <- read.csv(url) |> as_tibble()\n```\n\n```{webr-r}\n#| autorun: true\n## Estructura datos\ninventario_tbl\n```\n\n::: panel-tabset\n## Gr√°fico esperado\n\nEl resultado esperado es el de la @fig-distribution-ej8.\n\n::: callout-tip\nPara conseguir las dimensiones del gr√°fico tenemos que a√±adir la componente `coord_fixed(ratio = .5)`. Esto hace que una unidad del eje `x` sea equivalente a 0.5 unidades del eje `y` y por lo tanto, los rect√°ngulos tengan el doble de longitud en `x`\n:::\n\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Resultado esperado del ejercicio 8](1103_relationship_files/figure-html/fig-distribution-ej8-1.png){#fig-distribution-ej8 width=672}\n:::\n:::\n\n\n\n\n## Ejercicio\n\nLa paleta de colores utilizada es `hcl.colors(10, \"Greens\", rev = TRUE)`.\n\n```{webr-r}\n## Escribe el c√≥digo aqu√≠\ninventario_tbl\n```\n\n## Pista\n\nEl procesado de los datos es el siguiente:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninventario_tbl |> \n    summarise(\n        dbh_mean = mean(dbh_mm, na.rm = TRUE) / 10,\n        .by = c(id_plots, nombre_ifn)\n    ) |> \n    mutate(\n        dbh_mean = round(dbh_mean)\n    )\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 34 √ó 3\n   id_plots nombre_ifn       dbh_mean\n   <fct>    <fct>               <dbl>\n 1 0        Pinus sylvestris       20\n 2 0        Pinus nigra            14\n 3 2        Pinus sylvestris       17\n 4 3        Pinus sylvestris       21\n 5 4        Pinus sylvestris       15\n 6 5        Pinus nigra            16\n 7 6        Pinus sylvestris       17\n 8 7        Pinus sylvestris       18\n 9 8        Pinus sylvestris       24\n10 9        Pinus sylvestris       23\n# ‚Ñπ 24 more rows\n```\n\n\n:::\n:::\n\n\n\n\n## Soluci√≥n\n\nLa soluci√≥n al ejercicio es:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninventario_tbl |> \n    summarise(\n        dbh_mean = mean(dbh_mm, na.rm = TRUE) / 10,\n        .by = c(id_plots, nombre_ifn)\n    ) |> \n    mutate(\n        dbh_mean = round(dbh_mean)\n    ) |> \n    ggplot(\n        aes(y = nombre_ifn, x = id_plots)\n    ) +\n    geom_tile(\n        aes(fill = dbh_mean),\n        show.legend = FALSE\n    ) +\n    geom_text(\n        aes(label = dbh_mean),\n        size = 3\n    ) +\n    scale_fill_gradientn(\n        colours = hcl.colors(10, \"Greens\", rev = TRUE)\n    ) +\n    theme_minimal() +\n    labs(\n        x = \"Parcela\",\n        y = NULL,\n        title = \"DBH medio (cm) por parcela y especie\"\n    ) +\n    coord_fixed(ratio = .5) +\n    theme(\n        plot.title = element_text(hjust = .5, face = \"bold\")\n    )\n```\n\n::: {.cell-output-display}\n![Resultado final del ejercicio 8](1103_relationship_files/figure-html/fig-distribution-ej8-sol-1.png){#fig-distribution-ej8-sol width=672}\n:::\n:::\n\n\n\n:::\n\nFelicidades ü•≥ !!! Hemos aprendido mucho hasta este punto. Aunque est√©s confuso por el uso de algunas funciones del tipo `scale_*` o `coords_*`, no te preocupes! Esto ser√° cuesti√≥n de otro tema dedicado a ellas. De momento vamos introduciendo poco a poco estas componentes para que los ejercicios no sean solamente geometr√≠as, y para que te vayas familiarizando poco a poco con la gram√°tica. Sin m√°s dilaci√≥n, vamos a ver el siguiente tipo de *heatmaps*.\n\n### Mapa de calor de correlaci√≥n\n\nLos mapas de calor de correlaci√≥n (*correlacion heatmaps*) son una forma de visualizar la relaci√≥n entre **las variables num√©ricas** de un *dataset*. En estos mapas, las variables se representan en los ejes `x` e `y`, y la correlaci√≥n entre ellas se representa mediante el color de las celdas.\n\nPara entender esto, debemos definir la correlaci√≥n. La correlaci√≥n es una medida estad√≠stica que describe la relaci√≥n entre dos variables y tiene la siguiente f√≥rmula:\n\n$$\nr_{xy} = \\frac{cov(x,y)}{SD_x \\cdot SD_y}\n$$ {#eq-pearson1}\n\n$$\nr_{xy} = \\frac{\\sum_{i=1}^{n} (x_i - \\bar{x})(y_i - \\bar{y})}{\\sqrt{\\sum_{i=1}^{n} (x_i - \\bar{x})^2 \\sum_{i=1}^{n} (y_i - \\bar{y})^2}}\n$$ {#eq-pearson2}\n\nT√©cnicamente, esto es la [correlaci√≥n de Pearson](https://es.wikipedia.org/wiki/Coeficiente_de_correlaci%C3%B3n_de_Pearson){target=\"_blank\"} y mide el grado de correlaci√≥n **lineal** entre la variable `x` y la variable `y` dando como resultado un n√∫mero entre -1 y 1 donde:\n\n-   Valores negativos: cuando los valores de una variable aumentan, los de la otra disminuyen\n\n-   Valores cercanos a 0: no existe relaci√≥n lineal entre las variables\n\n-   Valores positivos: cuando los valores de una variable aumentan, lo de la otra tambi√©n\n\nEn la siguiente figura se muestran varios ejemplos:\n\n![Ejemplos de valores del coeficiente de correlaci√≥n de Pearson para distintas combinaciones de dos variables. Fuente: [Wikipedia](https://es.wikipedia.org/wiki/Coeficiente_de_correlaci%C3%B3n_de_Pearson#/media/Archivo:Correlation_examples2.svg){target=\"_blank\"}](images/correlacion-pearson.png){#fig-correlation-types fig-align=\"center\"}\n\nEn este sentido, vamos a generar el *correlation heatmap* para los datos de `iris`:\n\n::: panel-tabset\n## Correlaci√≥n\n\nLa correlaci√≥n se calcula solamente para variables num√©ricas, as√≠ que para seleccionar solamente estas, y calcular la correlaci√≥n con la funci√≥n `cor()`:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Calcular correlaci√≥n\niris_cor <- iris |> \n    select(\n        where(is.numeric)\n    ) |> \n    cor()\n## Imprimir\niris_cor\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n             Sepal.Length Sepal.Width Petal.Length Petal.Width\nSepal.Length    1.0000000  -0.1175698    0.8717538   0.8179411\nSepal.Width    -0.1175698   1.0000000   -0.4284401  -0.3661259\nPetal.Length    0.8717538  -0.4284401    1.0000000   0.9628654\nPetal.Width     0.8179411  -0.3661259    0.9628654   1.0000000\n```\n\n\n:::\n:::\n\n\n\n\nLa diagonal ser√° siempre 1, ya que la correlaci√≥n de una variable consigo misma siempre ser√° una recta.\n\n## Correlation heatmap\n\nExisten muchos paquetes que traen funciones internas que a partir de la matriz de correlaci√≥n crean un *correlation heatmap*. Uno de mis favoritos es `{GGally}`.\n\nDe hecho, gracias a este paquete, no tenemos que realizar el paso anterior, y simplemente a√±adiendo nuestro datos a la funci√≥n `ggcor()`, har√° el trabajo por nosotros:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggcorr(iris)\n```\n\n::: {.cell-output-display}\n![Mapa de calor de correlaci√≥n simple con `{GGally}`](1103_relationship_files/figure-html/fig-correlation-heatmap-1.png){#fig-correlation-heatmap width=672}\n:::\n:::\n\n\n\n\nEsta funci√≥n tiene par√°metros que podemos modificar. Adem√°s, como es un objeto de `{ggplot2}`, podemos modificarlo como tal:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggcorr(\n    iris,\n    label       = TRUE,\n    label_round = 2\n) +\n    labs(\n        title = \"Correlaci√≥n de Pearson del dataset de {iris}\"\n    ) +\n    theme(\n        plot.title = element_text(\n            hjust = .5,\n            face  = \"bold\"\n        )\n    )\n```\n\n::: {.cell-output-display}\n![Mapa de calor de correlaci√≥n personalizado con `{GGally}`](1103_relationship_files/figure-html/fig-correlation-heatmap2-1.png){#fig-correlation-heatmap2 width=672}\n:::\n:::\n\n\n\n\nCompara los valores de las etiquetas con los que obtuvimos al utilizar la funci√≥n `cor()`.\n\n## Correlaci√≥n por categor√≠as\n\nFinalmente, tenemos la opci√≥n de a√±adir una variable categ√≥rica como puede ser la especie de Iris, y ver la correlaci√≥n de cada variable por especie. Dentro de `{GGally}` tenemos la siguiente funci√≥n:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggpairs(\n    data = iris,\n    aes(color = Species)\n) +\n    theme_minimal(base_size = 8)\n```\n\n::: {.cell-output-display}\n![Mapa de calor de correlaci√≥n por especie con `{GGally}`](1103_relationship_files/figure-html/fig-correlation-heatmap3-1.png){#fig-correlation-heatmap3 width=672}\n:::\n:::\n\n\n\n\nMadre m√≠a, pero esto qu√© es ü•µü§Ø !! Pues aqu√≠ tenemos varias cosas:\n\n-   Colores: cada color representa una especie (rojo = setosa; verde = versicolor; azul = virginica)\n\n-   Tri√°ngulo inferior: relaci√≥n de las variables mediante *scatter plots* para pares de variables num√©ricas e histogramas para 1 variable num√©rica y 1 variable categ√≥rica.\n\n-   Diagonal: distribuci√≥n unitaria de cada variable. Gr√°ficos de densidad para num√©ricas, gr√°ficos de barras para variables categ√≥ricas.\n\n-   Tri√°ngulo superior: valores de correlaci√≥n para pares de variables num√©ricas. *Boxplots* para 1 variable num√©rica y 1 variable categ√≥rica.\n\nComo puedes ver, en b√°sicamente una l√≠nea de c√≥digo esta funci√≥n nos da una informaci√≥n MUY valiosa sobre nuestros datos. Esta funci√≥n la utilizo mucho durante el an√°lisis exploratorio de mis datos.\n:::\n\n### Ejercicio 9\n\nCrear un gr√°fico de correlaci√≥n con `{GGally}` para los datos de inventario.\n\nLa estructura de los datos era la siguiente:\n\n```{webr-r}\n#| autorun: true\n## Estructura datos\ninventario_tbl\n```\n\n::: panel-tabset\n\n## Gr√°fico esperado\n\nEl resultado esperado es el de la @fig-correlation-heatmap4. F√≠jate que no incluimos la variable `id_plots` en el gr√°fico.\n\nLos colores utilizados son `cols <- c(\"#E56399\", \"#7F96FF\")`. \n\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Resultado esperado del ejercicio 9](1103_relationship_files/figure-html/fig-correlation-heatmap-ej-1.png){#fig-correlation-heatmap-ej width=672}\n:::\n:::\n\n\n\n\n## Ejercicio\n\nReplica el gr√°fico anterior e intenta entender qu√© ocurre en cada subgr√°fico.\n\n```{webr-r}\n## Escribe el c√≥digo aqu√≠\ninventario_tbl\n```\n\n## Soluci√≥n\n\nEl resultado se muestra en la @fig-correlation-heatmap-sol. F√≠jate que tenemos que a√±adir tanto `scale_color_manual()` para cambiar los colores de los puntos y `scale_fill_manual()` para cambiar los de los rect√°ngulos.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Colores\ncols <- c(\"#E56399\", \"#7F96FF\")\n## Gr√°fico\ninventario_tbl |> \n  select(-id_plots) |>\n  ggpairs(\n    aes(color = nombre_ifn)\n  ) +\n  scale_color_manual(\n    values = cols\n  ) +\n  scale_fill_manual(\n    values = cols\n  ) +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![Resultado final del ejercicio 9](1103_relationship_files/figure-html/fig-correlation-heatmap-sol-1.png){#fig-correlation-heatmap-sol width=672}\n:::\n:::\n\n\n\n\n:::\n\nEnhorabuena! Has llegado al final de este cap√≠tulo. S√© que ha sido intenso, pero estamos aprendiendo mucho. En el pr√≥ximo cap√≠tulo vamos a ver algunos gr√°ficos de comparaci√≥n.\n\n## Resumen\n\nEn este cap√≠tulo hemos aprendido a crear gr√°ficos de dispersi√≥n y mapas de calor con `{ggplot2}`. Hemos aprendido a modificar las escalas de los ejes, a cambiar los colores de los puntos y a mover las leyendas. Adem√°s, hemos aprendido a crear mapas de calor de correlaci√≥n y a personalizarlos.\n",
    "supporting": [
      "1103_relationship_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}